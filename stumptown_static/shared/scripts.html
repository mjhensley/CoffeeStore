<!-- SITE CONFIGURATION: Load FIRST - single source of truth -->
<script src="site-config.js"></script>

<!-- INSTANT LOAD: Ultra-fast page transitions -->
<script src="instant-load.js"></script>

<!-- CENTRALIZED PRICING - Must load before other scripts -->
<script src="product-pricing.js"></script>

<!-- SHIPPING CONFIGURATION -->
<script src="shipping-config.js"></script>

<!-- TAX & PRICING MODULES -->
<script src="lib/tax.js"></script>
<script src="lib/pricing.js"></script>

<!-- DISCOUNT CONFIGURATION -->
<script src="discount-config.js"></script>

<!-- PERFORMANCE: Load fingerprinting for bot protection -->
<script src="fingerprint.js" defer></script>

<!-- PERFORMANCE: Load optimization module -->
<script src="performance.js" defer></script>

<!-- Account & Cart Scripts -->
<script src="account.js" defer></script>
<script src="cart.js" defer></script>
<script src="enhanced-products.js" defer></script>

<!-- Snipcart - Replace YOUR_PUBLIC_API_KEY with your Snipcart public API key -->
<div hidden id="snipcart" data-api-key="ODMwYTIxNjQtMjkxYy00YjNlLWI0NTAtYTkyNWFkNTdlNzNhNjM5MDE1ODA5OTIzMjEyMTUw" data-config-modal-style="side">
    <!-- Custom template for order summary items with images -->
    <order-summary-item-custom section="cart-summary-items">
        <li class="snipcart-cart-summary-item">
            <div class="snipcart-cart-summary-item__image" style="width:64px;height:64px;min-width:64px;border-radius:8px;overflow:hidden;background:#f8f6f3;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.08);">
                <img :src="item.image" :alt="item.name" style="width:100%;height:100%;object-fit:cover;">
            </div>
            <div class="snipcart-cart-summary-item__content" style="flex:1;min-width:0;">
                <div class="snipcart-cart-summary-item__name" style="font-weight:600;color:#333;font-size:14px;line-height:1.3;">{{ item.name }}</div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                    <span class="snipcart-cart-summary-item__quantity" style="color:#666;font-size:13px;">x{{ item.quantity }}</span>
                    <span class="snipcart-cart-summary-item__price" style="font-weight:600;color:#333;font-size:14px;">{{ item.totalPrice | money }}</span>
                </div>
            </div>
        </li>
    </order-summary-item-custom>
</div>
<script src="https://cdn.snipcart.com/themes/v3.2.0/default/snipcart.js" async defer></script>

<!-- Shared Mobile Menu & Cart Badge Script -->
<script>
    // Mobile Menu Toggle - Standardized across all pages
    (function() {
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavOverlay = document.getElementById('mobileNavOverlay');

        if (!mobileMenuBtn || !mobileNav || !mobileNavOverlay) return;

        function toggleMobileMenu() {
            const isOpen = mobileNav.classList.contains('active');
            mobileMenuBtn.classList.toggle('active');
            mobileNav.classList.toggle('active');
            mobileNavOverlay.classList.toggle('active');
            mobileMenuBtn.setAttribute('aria-expanded', !isOpen);
            document.body.style.overflow = isOpen ? '' : 'hidden';
        }

        mobileMenuBtn.addEventListener('click', toggleMobileMenu);
        mobileNavOverlay.addEventListener('click', toggleMobileMenu);

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && mobileNav.classList.contains('active')) {
                toggleMobileMenu();
            }
        });
    })();

    // Cart Badge Visibility - Standardized across all pages
    document.addEventListener('DOMContentLoaded', function() {
        function updateCartBadge() {
            const badge = document.querySelector('.cart-count-badge');
            if (badge) {
                const count = parseInt(badge.textContent) || 0;
                badge.classList.toggle('hidden', count === 0);
            }
        }
        updateCartBadge();
        const badge = document.querySelector('.cart-count-badge');
        if (badge) {
            const observer = new MutationObserver(updateCartBadge);
            observer.observe(badge, { childList: true, characterData: true, subtree: true });
        }
    });

    // Back to Top Button - Standardized across all pages
    (function() {
        const backToTopBtn = document.getElementById('backToTop');
        if (!backToTopBtn) return;
        
        window.addEventListener('scroll', function() {
            if (window.scrollY > 500) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        });
        
        backToTopBtn.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    })();

    // Newsletter Form Handler - Standardized across all pages
    function handleNewsletterSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const email = form.querySelector('input').value;
        const button = form.querySelector('button');
        const originalText = button.textContent;
        
        button.textContent = 'Subscribing...';
        button.disabled = true;
        
        // Simulate API call
        setTimeout(function() {
            button.textContent = '‚úì Subscribed!';
            button.style.background = '#2d5a3d';
            button.style.color = '#fff';
            form.querySelector('input').value = '';
            
            setTimeout(function() {
                button.textContent = originalText;
                button.style.background = '';
                button.style.color = '';
                button.disabled = false;
            }, 3000);
        }, 1000);
    }

    // Banner scroll animation fallback - Standardized across all pages
    (function() {
        const bannerScroll = document.querySelector('.banner-scroll');
        if (!bannerScroll) return;
        
        let animationRunning = false;
        
        const checkAnimation = function() {
            const style = window.getComputedStyle(bannerScroll);
            const animName = style.animationName || style.webkitAnimationName;
            const animDuration = parseFloat(style.animationDuration) || parseFloat(style.webkitAnimationDuration);
            
            if (!animName || animName === 'none' || !animDuration) {
                if (!animationRunning) {
                    startJSAnimation();
                }
            }
        };
        
        function startJSAnimation() {
            if (animationRunning) return;
            animationRunning = true;
            
            let position = 0;
            const speed = 1;
            const scrollWidth = bannerScroll.scrollWidth / 2;
            
            function animate() {
                if (!bannerScroll || !bannerScroll.parentElement) {
                    animationRunning = false;
                    return;
                }
                
                position -= speed;
                if (position <= -scrollWidth) {
                    position = 0;
                }
                bannerScroll.style.transform = 'translateX(' + position + 'px)';
                requestAnimationFrame(animate);
            }
            
            bannerScroll.style.animation = 'none';
            bannerScroll.style.webkitAnimation = 'none';
            animate();
        }
        
        setTimeout(checkAnimation, 500);
    })();

    // Site Sanity Check - Debug mode (only on localhost)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        window.addEventListener('DOMContentLoaded', function() {
            const checks = {
                'Global JS': typeof handleNewsletterSubmit !== 'undefined',
                'Snipcart': typeof window.Snipcart !== 'undefined',
                'Product Pricing': typeof getProductConfig !== 'undefined',
                'Cart System': typeof window.GrainhouseCart !== 'undefined' || typeof window.Snipcart !== 'undefined'
            };
            
            console.log('üîç Site Sanity Check:');
            Object.entries(checks).forEach(([name, passed]) => {
                console.log(`  ${passed ? '‚úÖ' : '‚ùå'} ${name}: ${passed ? 'Loaded' : 'Missing'}`);
            });
            
            // Check for Snipcart errors
            window.addEventListener('error', function(e) {
                if (e.target && e.target.src && e.target.src.includes('snipcart')) {
                    console.error('‚ùå Snipcart script failed to load:', e.target.src);
                }
            }, true);
        });
    }
</script>

